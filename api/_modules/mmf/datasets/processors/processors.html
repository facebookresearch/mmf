


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mmf.datasets.processors.processors | MMF 1.0.0rc12 documentation</title>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135079836-2"></script>
  <script src="../../../../_static/js/ga.js"></script>
  <script src="../../../../_static/js/redirect.js"></script>
  
  <link rel="shortcut icon" href="../../../../_static/images/favicon.png"/>
  
  
  <link rel="canonical" href="https://mmf.sh/api/_modules/mmf/datasets/processors/processors.html"/>
  
  <meta property="og:title" content="mmf.datasets.processors.processors | MMF 1.0.0rc12 documentation">
  <meta name="description" content="API docs for MMF. MMF is a modular framework powered by PyTorch for multimodal vision and language research from Facebook AI Research">
  <meta property="og:description" content="API docs for MMF. MMF is a modular framework powered by PyTorch for multimodal vision and language research from Facebook AI Research">
  <meta property="og:image" content="https://mmf.sh/img/logo.png">
  <meta property="twitter:image" content="https://mmf.sh/img/logo.png">
  <meta name="twitter:image:alt" content="Image for MMF">
  <meta name="twitter:card" content="summary_large_image">
  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/customize.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://mmf.sh/" aria-label="MMF"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://mmf.sh/docs">Get Started</a>
          </li>


          <li>
            <a href="https://mmf.sh/docs">Docs</a>
          </li>

          <li class="active">
            <a href="https://mmf.sh/api">API</a>
          </li>

          <li>
            <a href="https://github.com/facebookresearch/mmf">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  1.0.0
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Library Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/common/registry.html">common.registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/common/sample.html">common.sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/models/base_model.html">models.base_model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/modules/losses.html">modules.losses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/modules/metrics.html">modules.metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/datasets/base_dataset_builder.html">datasets.base_dataset_builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/datasets/base_dataset.html">datasets.base_dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/datasets/processors.html">datasets.processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/utils/text.html">utils.text</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../../index.html">Module code</a> &gt;</li>
        
      <li>mmf.datasets.processors.processors</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for mmf.datasets.processors.processors</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Facebook, Inc. and its affiliates.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The processors exist in MMF to make data processing pipelines in various</span>
<span class="sd">datasets as similar as possible while allowing code reuse.</span>

<span class="sd">The processors also help maintain proper abstractions to keep only what matters</span>
<span class="sd">inside the dataset&#39;s code. This allows us to keep the dataset ``__getitem__``</span>
<span class="sd">logic really clean and no need about maintaining opinions about data type.</span>
<span class="sd">Processors can work on both images and text due to their generic structure.</span>

<span class="sd">To create a new processor, follow these steps:</span>

<span class="sd">1. Inherit the ``BaseProcessor`` class.</span>
<span class="sd">2. Implement ``_call`` function which takes in a dict and returns a dict with</span>
<span class="sd">   same keys preprocessed as well as any extra keys that need to be returned.</span>
<span class="sd">3. Register the processor using ``@registry.register_processor(&#39;name&#39;)`` to</span>
<span class="sd">   registry where &#39;name&#39; will be used to refer to your processor later.</span>

<span class="sd">In processor&#39;s config you can specify ``preprocessor`` option to specify</span>
<span class="sd">different kind of preprocessors you want in your dataset.</span>

<span class="sd">Let&#39;s break down processor&#39;s config inside a dataset (VQA2.0) a bit to understand</span>
<span class="sd">different moving parts.</span>

<span class="sd">Config::</span>

<span class="sd">    dataset_config:</span>
<span class="sd">      vqa2:</span>
<span class="sd">        data_dir: ${env.data_dir}</span>
<span class="sd">        processors:</span>
<span class="sd">          text_processor:</span>
<span class="sd">            type: vocab</span>
<span class="sd">            params:</span>
<span class="sd">              max_length: 14</span>
<span class="sd">              vocab:</span>
<span class="sd">                type: intersected</span>
<span class="sd">                embedding_name: glove.6B.300d</span>
<span class="sd">                vocab_file: vqa2/defaults/extras/vocabs/vocabulary_100k.txt</span>
<span class="sd">              preprocessor:</span>
<span class="sd">                type: simple_sentence</span>
<span class="sd">                params: {}</span>

<span class="sd">``BaseDataset`` will init the processors and they will available inside your</span>
<span class="sd">dataset with same attribute name as the key name, for e.g. `text_processor` will</span>
<span class="sd">be available as `self.text_processor` inside your dataset. As is with every module</span>
<span class="sd">in MMF, processor also accept a ``DictConfig`` with a `type` and `params`</span>
<span class="sd">attributes. `params` defined the custom parameters for each of the processors.</span>
<span class="sd">By default, processor initialization process will also init `preprocessor` attribute</span>
<span class="sd">which can be a processor config in itself. `preprocessor` can be then be accessed</span>
<span class="sd">inside the processor&#39;s functions.</span>

<span class="sd">Example::</span>

<span class="sd">    from mmf.common.registry import registry</span>
<span class="sd">    from mmf.datasets.processors import BaseProcessor</span>

<span class="sd">    @registry.register_processor(&#39;my_processor&#39;)</span>
<span class="sd">    class MyProcessor(BaseProcessor):</span>
<span class="sd">        def __init__(self, config, *args, **kwargs):</span>
<span class="sd">            return</span>

<span class="sd">        def __call__(self, item, *args, **kwargs):</span>
<span class="sd">            text = item[&#39;text&#39;]</span>
<span class="sd">            text = [t.strip() for t in text.split(&quot; &quot;)]</span>
<span class="sd">            return {&quot;text&quot;: text}</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">mmf.common.registry</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">mmf.common.typings</span> <span class="kn">import</span> <span class="n">ProcessorConfigType</span>
<span class="kn">from</span> <span class="nn">mmf.utils.configuration</span> <span class="kn">import</span> <span class="n">get_mmf_cache_dir</span><span class="p">,</span> <span class="n">get_mmf_env</span>
<span class="kn">from</span> <span class="nn">mmf.utils.distributed</span> <span class="kn">import</span> <span class="n">is_master</span><span class="p">,</span> <span class="n">synchronize</span>
<span class="kn">from</span> <span class="nn">mmf.utils.file_io</span> <span class="kn">import</span> <span class="n">PathManager</span>
<span class="kn">from</span> <span class="nn">mmf.utils.logger</span> <span class="kn">import</span> <span class="n">log_class_usage</span>
<span class="kn">from</span> <span class="nn">mmf.utils.text</span> <span class="kn">import</span> <span class="n">VocabDict</span>
<span class="kn">from</span> <span class="nn">mmf.utils.vocab</span> <span class="kn">import</span> <span class="n">Vocab</span><span class="p">,</span> <span class="n">WordToVectorDict</span>
<span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">DictConfig</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="BatchProcessorConfigType"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.BatchProcessorConfigType">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BatchProcessorConfigType</span><span class="p">:</span>
    <span class="n">processors</span><span class="p">:</span> <span class="n">ProcessorConfigType</span></div>


<div class="viewcode-block" id="BaseProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.BaseProcessor">[docs]</a><span class="k">class</span> <span class="nc">BaseProcessor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Every processor in MMF needs to inherit this class for compatibility</span>
<span class="sd">    with MMF. End user mainly needs to implement ``__call__`` function.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DictConfig): Config for this processor, containing `type` and</span>
<span class="sd">                             `params` attributes if available.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DictConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">log_class_usage</span><span class="p">(</span><span class="s2">&quot;Processor&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Main function of the processor. Takes in a dict and returns back</span>
<span class="sd">        a dict</span>

<span class="sd">        Args:</span>
<span class="sd">            item (Dict): Some item that needs to be processed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: Processed dict.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">item</span></div>


<div class="viewcode-block" id="Processor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.Processor">[docs]</a><span class="k">class</span> <span class="nc">Processor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Wrapper class used by MMF to initialized processor based on their</span>
<span class="sd">    ``type`` as passed in configuration. It retrieves the processor class</span>
<span class="sd">    registered in registry corresponding to the ``type`` key and initializes</span>
<span class="sd">    with ``params`` passed in configuration. All functions and attributes of</span>
<span class="sd">    the processor initialized are directly available via this class.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DictConfig): DictConfig containing ``type`` of the processor to</span>
<span class="sd">                             be initialized and ``params`` of that processor.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ProcessorConfigType</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;Config must have &#39;type&#39; attribute to specify type of processor&quot;</span>
            <span class="p">)</span>

        <span class="n">processor_class</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_processor_class</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;params&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Config doesn&#39;t have &#39;params&#39; attribute to &quot;</span>
                <span class="s2">&quot;specify parameters of the processor &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;of type </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">. Setting to default </span><span class="se">{{}}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">params</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">processor_class</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_representation</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_dir_representation&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_representation</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;processor&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The processor </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t exist in the registry.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BatchProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.BatchProcessor">[docs]</a><span class="k">class</span> <span class="nc">BatchProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;BatchProcessor is an extension of normal processor which usually are</span>
<span class="sd">    used in cases where dataset works on full batch instead of samples.</span>
<span class="sd">    Such cases can be observed in the case of the iterable datasets.</span>
<span class="sd">    BatchProcessor if provided with processors key in the config, will</span>
<span class="sd">    initialize a member variable processors_dict for you which will contain</span>
<span class="sd">    initialization of all of the processors you specified and will need to process</span>
<span class="sd">    your complete batch.</span>

<span class="sd">    Rest it behaves in same way, expects an item and returns an item which can be</span>
<span class="sd">    of any type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">BatchProcessorConfigType</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">extra_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data_dir&quot;</span><span class="p">:</span> <span class="n">get_mmf_env</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;data_dir&quot;</span><span class="p">)}</span>
        <span class="n">processors_dict</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;processors&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Since build_processors also imports processor, import it at runtime to</span>
        <span class="c1"># avoid circular dependencies</span>
        <span class="kn">from</span> <span class="nn">mmf.utils.build</span> <span class="kn">import</span> <span class="n">build_processors</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processors</span> <span class="o">=</span> <span class="n">build_processors</span><span class="p">(</span><span class="n">processors_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">item</span></div>


<div class="viewcode-block" id="VocabProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.VocabProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;vocab&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">VocabProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use VocabProcessor when you have vocab file and you want to process</span>
<span class="sd">    words to indices. Expects UNK token as &quot;&lt;unk&gt;&quot; and pads sentences using</span>
<span class="sd">    &quot;&lt;pad&gt;&quot; token. Config parameters can have ``preprocessor`` property which</span>
<span class="sd">    is used to preprocess the item passed and ``max_length`` property which</span>
<span class="sd">    points to maximum length of the sentence/tokens which can be convert to</span>
<span class="sd">    indices. If the length is smaller, the sentence will be padded. Parameters</span>
<span class="sd">    for &quot;vocab&quot; are necessary to be passed.</span>

<span class="sd">    **Key**: vocab</span>

<span class="sd">    Example Config::</span>

<span class="sd">        dataset_config:</span>
<span class="sd">          vqa2:</span>
<span class="sd">            data_dir: ${env.data_dir}</span>
<span class="sd">            processors:</span>
<span class="sd">              text_processor:</span>
<span class="sd">                type: vocab</span>
<span class="sd">                params:</span>
<span class="sd">                  max_length: 14</span>
<span class="sd">                  vocab:</span>
<span class="sd">                    type: intersected</span>
<span class="sd">                    embedding_name: glove.6B.300d</span>
<span class="sd">                    vocab_file: vqa2/defaults/extras/vocabs/vocabulary_100k.txt</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DictConfig): node containing configuration parameters of</span>
<span class="sd">                             the processor</span>

<span class="sd">    Attributes:</span>
<span class="sd">        vocab (Vocab): Vocab class object which is abstraction over the vocab</span>
<span class="sd">                       file passed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MAX_LENGTH_DEFAULT</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">PAD_TOKEN</span> <span class="o">=</span> <span class="s2">&quot;&lt;pad&gt;&quot;</span>
    <span class="n">PAD_INDEX</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;vocab&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;config passed to the processor has no attribute vocab&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">Vocab</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_extras</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_extras</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;No &#39;max_length&#39; parameter in Processor&#39;s &quot;</span>
                <span class="s2">&quot;configuration. Setting to </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_LENGTH_DEFAULT</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LENGTH_DEFAULT</span>

        <span class="k">if</span> <span class="s2">&quot;preprocessor&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Processor</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No text processor named </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">preprocessor</span><span class="si">}</span><span class="s2"> is defined.&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call requires item to have either &quot;tokens&quot; attribute or either</span>
<span class="sd">        &quot;text&quot; attribute. If &quot;text&quot; is present, it will tokenized using</span>
<span class="sd">        the preprocessor.</span>

<span class="sd">        Args:</span>
<span class="sd">            item (Dict): Dict containing the &quot;text&quot; or &quot;tokens&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: Dict containing indices in &quot;text&quot; key, &quot;tokens&quot; in &quot;tokens&quot;</span>
<span class="sd">                  key and &quot;length&quot; of the string in &quot;length&quot; key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Argument passed to the processor must be &quot;</span>
                <span class="s2">&quot;a dict with either &#39;text&#39; or &#39;tokens&#39; as &quot;</span>
                <span class="s2">&quot;keys&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;tokens&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_strings_to_indices</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="s2">&quot;If tokens are not provided, a text &quot;</span>
                    <span class="s2">&quot;processor must be defined in the config&quot;</span>
                <span class="p">)</span>

            <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]})[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_strings_to_indices</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;A dict with either &#39;text&#39; or &#39;tokens&#39; keys &quot;</span>
                <span class="s2">&quot;must be passed to the processor&quot;</span>
            <span class="p">)</span>

        <span class="n">tokens</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_tokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span> <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="n">length</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_pad_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="n">padded_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">PAD_TOKEN</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span>
        <span class="n">token_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>
        <span class="n">padded_tokens</span><span class="p">[:</span><span class="n">token_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">token_length</span><span class="p">]</span>
        <span class="n">token_length</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">token_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">padded_tokens</span><span class="p">,</span> <span class="n">token_length</span>

<div class="viewcode-block" id="VocabProcessor.get_pad_index"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.VocabProcessor.get_pad_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_pad_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get index of padding &lt;pad&gt; token in vocabulary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: index of the padding token.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">()</span></div>

<div class="viewcode-block" id="VocabProcessor.get_vocab_size"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.VocabProcessor.get_vocab_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get size of the vocabulary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: size of the vocabulary.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_map_strings_to_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">stoi</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="GloVeProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.GloVeProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;glove&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">GloVeProcessor</span><span class="p">(</span><span class="n">VocabProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inherits VocabProcessor, and returns GloVe vectors for each of the</span>
<span class="sd">    words. Maps them to index using vocab processor, and then gets GloVe vectors</span>
<span class="sd">    corresponding to those indices.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DictConfig): Configuration parameters for GloVe same as</span>
<span class="sd">                             :func:`~VocabProcessor`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;vocab&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;Config passed to the processor has no attribute vocab&quot;</span>
            <span class="p">)</span>
        <span class="n">vocab_processor_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="c1"># GloVeProcessor needs vocab type to be &quot;intersected&quot;</span>
        <span class="n">vocab_processor_config</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;intersected&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;vocab_file&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vocab_processor_config</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;&#39;vocab_file&#39; key is not present in the config.&quot;</span>
                <span class="s2">&quot; Switching to pretrained vocab.&quot;</span>
            <span class="p">)</span>

            <span class="n">vocab_processor_config</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;pretrained&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_extras</span><span class="p">(</span><span class="n">vocab_processor_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">vocab_processor_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_already_downloaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_already_downloaded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">Vocab</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_already_downloaded</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">item</span><span class="p">)[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_embedding_dim</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="n">embeddings</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">vectors</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">embeddings</span><span class="p">}</span></div>


<div class="viewcode-block" id="FastTextProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.FastTextProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;fasttext&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">FastTextProcessor</span><span class="p">(</span><span class="n">VocabProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;FastText processor, similar to GloVe processor but returns FastText vectors.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DictConfig): Configuration values for the processor.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_extras</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_download_initially</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_initially&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_already_downloaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_already_loaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_initially</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_try_download</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_try_download</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_is_master</span> <span class="o">=</span> <span class="n">is_master</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_already_downloaded</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">needs_download</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;model_file&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_is_master</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;model_file&#39; key is required but missing &quot;</span>
                    <span class="s2">&quot;from FastTextProcessor&#39;s config.&quot;</span>
                <span class="p">)</span>
            <span class="n">needs_download</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">model_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_file</span>
        <span class="c1"># If model_file is already an existing path don&#39;t join to cache dir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PathManager</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_file</span><span class="p">):</span>
            <span class="n">model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_mmf_cache_dir</span><span class="p">(),</span> <span class="n">model_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">PathManager</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_is_master</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No model file present at </span><span class="si">{</span><span class="n">model_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">needs_download</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">needs_download</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading FastText bin&quot;</span><span class="p">)</span>
            <span class="n">model_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_model</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="o">=</span> <span class="n">model_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_already_downloaded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">synchronize</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_download_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_is_master</span> <span class="o">=</span> <span class="n">is_master</span><span class="p">()</span>

        <span class="n">model_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_mmf_cache_dir</span><span class="p">(),</span> <span class="s2">&quot;wiki.en.bin&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_master</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model_file_path</span>

        <span class="k">if</span> <span class="n">PathManager</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_file_path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vectors already present at </span><span class="si">{</span><span class="n">model_file_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">model_file_path</span>

        <span class="kn">import</span> <span class="nn">requests</span>
        <span class="kn">from</span> <span class="nn">mmf.common.constants</span> <span class="kn">import</span> <span class="n">FASTTEXT_WIKI_URL</span>
        <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

        <span class="n">PathManager</span><span class="o">.</span><span class="n">mkdirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_file_path</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FASTTEXT_WIKI_URL</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">PathManager</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">model_file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4096</span><span class="p">,</span>
                <span class="n">miniters</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">_is_master</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fastText bin downloaded at </span><span class="si">{</span><span class="n">model_file_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_file_path</span>

    <span class="k">def</span> <span class="nf">_load_fasttext_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_file</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_already_loaded</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="kn">from</span> <span class="nn">fasttext</span> <span class="kn">import</span> <span class="n">load_model</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading fasttext model now from </span><span class="si">{</span><span class="n">model_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
        <span class="c1"># String to Vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stov</span> <span class="o">=</span> <span class="n">WordToVectorDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished loading fasttext model&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_already_loaded</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_map_strings_to_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_dimension</span><span class="p">()),</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PAD_INDEX</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stov</span><span class="p">[</span><span class="n">token</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_fasttext_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="VQAAnswerProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.VQAAnswerProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;vqa_answer&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">VQAAnswerProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Processor for generating answer scores for answers passed using VQA</span>
<span class="sd">    accuracy formula. Using VocabDict class to represent answer vocabulary,</span>
<span class="sd">    so parameters must specify &quot;vocab_file&quot;. &quot;num_answers&quot; in parameter config</span>
<span class="sd">    specify the max number of answers possible. Takes in dict containing</span>
<span class="sd">    &quot;answers&quot; or &quot;answers_tokens&quot;. &quot;answers&quot; are preprocessed to generate</span>
<span class="sd">    &quot;answers_tokens&quot; if passed.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DictConfig): Configuration for the processor</span>

<span class="sd">    Attributes:</span>
<span class="sd">        answer_vocab (VocabDict): Class representing answer vocabulary</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEFAULT_NUM_ANSWERS</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;vocab_file&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;vocab_file&#39; argument required, but not &quot;</span>
                <span class="s2">&quot;present in AnswerProcessor&#39;s config&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span> <span class="o">=</span> <span class="n">VocabDict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">vocab_file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PAD_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="s2">&quot;&lt;pad&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BOS_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="s2">&quot;&lt;s&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EOS_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="s2">&quot;&lt;/s&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UNK_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span>

        <span class="c1"># Set EOS to something not achievable if it is not there</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EOS_IDX</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNK_IDX</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EOS_IDX</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;preprocessor&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Processor</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No processor named </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">preprocessor</span><span class="si">}</span><span class="s2"> is defined.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;num_answers&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_answers</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_answers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_answers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;&#39;num_answers&#39; not defined in the config. &quot;</span>
                <span class="s2">&quot;Setting to default of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes in dict with answers or answers_tokens, and returns back</span>
<span class="sd">        a dict with answers (processed), &quot;answers_indices&quot; which point to</span>
<span class="sd">        indices of the answers if present and &quot;answers_scores&quot; which represent</span>
<span class="sd">        VQA style scores for the answers.</span>

<span class="sd">        Args:</span>
<span class="sd">            item (Dict): Dict containing answers or answers_tokens</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: Processed answers, indices and scores.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;item&#39; passed to processor must be a dict&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;answer_tokens&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;answer_tokens&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;answers&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;answers&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;preprocessor&#39; must be defined if you &quot;</span>
                    <span class="s2">&quot;don&#39;t pass &#39;answer_tokens&#39;&quot;</span>
                <span class="p">)</span>

            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">answer</span><span class="p">})[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;answers&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;answers&#39; or &#39;answer_tokens&#39; must be passed&quot;</span>
                <span class="s2">&quot; to answer processor in a dict&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increase_to_ten</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="n">answers_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="n">answers_indices</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">get_unk_index</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="n">answers_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="n">answers_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_answers_scores</span><span class="p">(</span><span class="n">answers_indices</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answers&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span>
            <span class="s2">&quot;answers_indices&quot;</span><span class="p">:</span> <span class="n">answers_indices</span><span class="p">,</span>
            <span class="s2">&quot;answers_scores&quot;</span><span class="p">:</span> <span class="n">answers_scores</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="VQAAnswerProcessor.get_vocab_size"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.VQAAnswerProcessor.get_vocab_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get vocab size of the answer vocabulary. Can also include</span>
<span class="sd">        soft copy dynamic answer space size.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: size of the answer vocabulary</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">num_vocab</span></div>

<div class="viewcode-block" id="VQAAnswerProcessor.get_true_vocab_size"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.VQAAnswerProcessor.get_true_vocab_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_true_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True vocab size can be different from normal vocab size in some cases</span>
<span class="sd">        such as soft copy where dynamic answer space is added.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: True vocab size.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">num_vocab</span></div>

<div class="viewcode-block" id="VQAAnswerProcessor.word2idx"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.VQAAnswerProcessor.word2idx">[docs]</a>    <span class="k">def</span> <span class="nf">word2idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a word to its index according to vocabulary</span>

<span class="sd">        Args:</span>
<span class="sd">            word (str): Word to be converted to index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Index of the word.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="n">word</span><span class="p">)</span></div>

<div class="viewcode-block" id="VQAAnswerProcessor.idx2word"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.VQAAnswerProcessor.idx2word">[docs]</a>    <span class="k">def</span> <span class="nf">idx2word</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Index to word according to the vocabulary.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx (int): Index to be converted to the word.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Word corresponding to the index.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">idx2word</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="VQAAnswerProcessor.compute_answers_scores"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.VQAAnswerProcessor.compute_answers_scores">[docs]</a>    <span class="k">def</span> <span class="nf">compute_answers_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answers_indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate VQA based answer scores for answers_indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            answers_indices (torch.LongTensor): tensor containing indices of the answers</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: tensor containing scores.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vocab_size</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">gt_answers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">answers_indices</span><span class="p">))</span>
        <span class="n">unique_answers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">answers_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">unique_answers</span><span class="p">:</span>
            <span class="n">accs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">gt_answer</span> <span class="ow">in</span> <span class="n">gt_answers</span><span class="p">:</span>
                <span class="n">other_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">gt_answers</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="n">gt_answer</span><span class="p">]</span>

                <span class="n">matching_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">other_answers</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">answer</span><span class="p">]</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matching_answers</span><span class="p">))</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            <span class="n">avg_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">answer</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">answer</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_acc</span>

        <span class="k">return</span> <span class="n">scores</span></div>

    <span class="k">def</span> <span class="nf">_increase_to_ten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">+=</span> <span class="n">tokens</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">tokens</span></div>


<div class="viewcode-block" id="GraphVQAAnswerProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.GraphVQAAnswerProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;graph_vqa_answer&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">GraphVQAAnswerProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Processor for generating answer scores for answers passed using VQA</span>
<span class="sd">    accuracy formula. Using VocabDict class to represent answer vocabulary,</span>
<span class="sd">    so parameters must specify &quot;vocab_file&quot;. &quot;num_answers&quot; in parameter config</span>
<span class="sd">    specify the max number of answers possible. Takes in dict containing</span>
<span class="sd">    &quot;answers&quot; or &quot;answers_tokens&quot;. &quot;answers&quot; are preprocessed to generate</span>
<span class="sd">    &quot;answers_tokens&quot; if passed.</span>

<span class="sd">    This version also takes a graph vocab and predicts a main and graph stream simultanously</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DictConfig): Configuration for the processor</span>

<span class="sd">    Attributes:</span>
<span class="sd">        answer_vocab (VocabDict): Class representing answer vocabulary</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEFAULT_NUM_ANSWERS</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;vocab_file&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;vocab_file&#39; argument required, but not &quot;</span>
                <span class="s2">&quot;present in AnswerProcessor&#39;s config&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span> <span class="o">=</span> <span class="n">VocabDict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">vocab_file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PAD_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="s2">&quot;&lt;pad&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BOS_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="s2">&quot;&lt;s&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EOS_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="s2">&quot;&lt;/s&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UNK_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span>

        <span class="c1"># Set EOS to something not achievable if it is not there</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EOS_IDX</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNK_IDX</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EOS_IDX</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;preprocessor&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Processor</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No processor named </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">preprocessor</span><span class="si">}</span><span class="s2"> is defined.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;num_answers&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_answers</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_answers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_answers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;&#39;num_answers&#39; not defined in the config. &quot;</span>
                <span class="s2">&quot;Setting to default of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Load the graph answer vocab file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">graph_vocab_file</span><span class="p">):</span>
            <span class="n">graph_vocab_file</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">graph_vocab_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph_vocab_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MMF_DATA_DIR&quot;</span><span class="p">),</span> <span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">graph_vocab_file</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_vocab</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">graph_vocab_file</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ans2graphvocabidx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">graphvocabidx</span><span class="p">,</span> <span class="n">graph_ans</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_vocab</span><span class="p">):</span>
            <span class="c1"># Right now, this does need to overlap with the regular vocab</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ans2graphvocabidx</span><span class="p">[</span><span class="n">graph_ans</span><span class="p">]</span> <span class="o">=</span> <span class="n">graphvocabidx</span>

            <span class="c1"># Make sure graph_ans actually in vocab</span>
            <span class="k">assert</span> <span class="n">graph_ans</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx_dict</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes in dict with answers or answers_tokens, and returns back</span>
<span class="sd">        a dict with answers (processed), &quot;answers_indices&quot; which point to</span>
<span class="sd">        indices of the answers if present and &quot;answers_scores&quot; which represent</span>
<span class="sd">        VQA style scores for the answers.</span>

<span class="sd">        Args:</span>
<span class="sd">            item (Dict): Dict containing answers or answers_tokens</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: Processed answers, indices and scores.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;item&#39; passed to processor must be a dict&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;answer_tokens&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;answer_tokens&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;answers&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;answers&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;preprocessor&#39; must be defined if you &quot;</span>
                    <span class="s2">&quot;don&#39;t pass &#39;answer_tokens&#39;&quot;</span>
                <span class="p">)</span>

            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">answer</span><span class="p">})[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;answers&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;answers&#39; or &#39;answer_tokens&#39; must be passed&quot;</span>
                <span class="s2">&quot; to answer processor in a dict&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increase_to_ten</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="n">answers_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="n">answers_indices</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">get_unk_index</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="n">answers_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="n">answers_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_answers_scores</span><span class="p">(</span><span class="n">answers_indices</span><span class="p">)</span>

        <span class="c1"># Get answer scores for the graph vocab</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">concat_scores</span><span class="p">:</span>
            <span class="n">answers_scores_graph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_vocab</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">unique_answers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">answers_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">unique_answers</span><span class="p">:</span>
                <span class="c1"># Get the original score</span>
                <span class="k">if</span> <span class="n">answer</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">answers_scores</span><span class="p">[</span><span class="n">answer</span><span class="p">]</span>

                    <span class="c1"># Copy into graph scores (if it&#39;s in there)</span>
                    <span class="n">ans_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">idx2word</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ans_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ans2graphvocabidx</span><span class="p">:</span>
                        <span class="n">graph_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ans2graphvocabidx</span><span class="p">[</span><span class="n">ans_str</span><span class="p">]</span>
                        <span class="n">answers_scores_graph</span><span class="p">[</span><span class="n">graph_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

            <span class="c1"># Concat scores</span>
            <span class="n">answers_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">answers_scores</span><span class="p">,</span> <span class="n">answers_scores_graph</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answers&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span>
            <span class="s2">&quot;answers_indices&quot;</span><span class="p">:</span> <span class="n">answers_indices</span><span class="p">,</span>
            <span class="s2">&quot;answers_scores&quot;</span><span class="p">:</span> <span class="n">answers_scores</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="GraphVQAAnswerProcessor.get_vocab_size"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.GraphVQAAnswerProcessor.get_vocab_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get vocab size of the answer vocabulary. Can also include</span>
<span class="sd">        soft copy dynamic answer space size.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: size of the answer vocabulary</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">num_vocab</span></div>

<div class="viewcode-block" id="GraphVQAAnswerProcessor.get_true_vocab_size"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.GraphVQAAnswerProcessor.get_true_vocab_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_true_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True vocab size can be different from normal vocab size in some cases</span>
<span class="sd">        such as soft copy where dynamic answer space is added.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: True vocab size.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">num_vocab</span></div>

<div class="viewcode-block" id="GraphVQAAnswerProcessor.word2idx"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.GraphVQAAnswerProcessor.word2idx">[docs]</a>    <span class="k">def</span> <span class="nf">word2idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a word to its index according to vocabulary</span>

<span class="sd">        Args:</span>
<span class="sd">            word (str): Word to be converted to index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Index of the word.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="n">word</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphVQAAnswerProcessor.idx2word"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.GraphVQAAnswerProcessor.idx2word">[docs]</a>    <span class="k">def</span> <span class="nf">idx2word</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Index to word according to the vocabulary.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx (int): Index to be converted to the word.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Word corresponding to the index.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">idx2word</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphVQAAnswerProcessor.compute_answers_scores"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.GraphVQAAnswerProcessor.compute_answers_scores">[docs]</a>    <span class="k">def</span> <span class="nf">compute_answers_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answers_indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate VQA based answer scores for answers_indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            answers_indices (torch.LongTensor): tensor containing indices of the answers</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: tensor containing scores.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vocab_size</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">gt_answers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">answers_indices</span><span class="p">))</span>
        <span class="n">unique_answers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">answers_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">unique_answers</span><span class="p">:</span>
            <span class="n">accs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">gt_answer</span> <span class="ow">in</span> <span class="n">gt_answers</span><span class="p">:</span>
                <span class="n">other_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">gt_answers</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="n">gt_answer</span><span class="p">]</span>

                <span class="n">matching_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">other_answers</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">answer</span><span class="p">]</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matching_answers</span><span class="p">))</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            <span class="n">avg_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">answer</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">answer</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_acc</span>

        <span class="k">return</span> <span class="n">scores</span></div>

    <span class="k">def</span> <span class="nf">_increase_to_ten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">+=</span> <span class="n">tokens</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_ANSWERS</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">tokens</span></div>


<div class="viewcode-block" id="MultiHotAnswerFromVocabProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.MultiHotAnswerFromVocabProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;multi_hot_answer_from_vocab&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MultiHotAnswerFromVocabProcessor</span><span class="p">(</span><span class="n">VQAAnswerProcessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="MultiHotAnswerFromVocabProcessor.compute_answers_scores"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.MultiHotAnswerFromVocabProcessor.compute_answers_scores">[docs]</a>    <span class="k">def</span> <span class="nf">compute_answers_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answers_indices</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vocab_size</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="n">answers_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">scores</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">scores</span></div></div>


<div class="viewcode-block" id="SoftCopyAnswerProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.SoftCopyAnswerProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;soft_copy_answer&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SoftCopyAnswerProcessor</span><span class="p">(</span><span class="n">VQAAnswerProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Similar to Answer Processor but adds soft copy dynamic answer space to it.</span>
<span class="sd">    Read https://arxiv.org/abs/1904.08920 for extra information on soft copy</span>
<span class="sd">    and LoRRA.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DictConfig): Configuration for soft copy processor.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEFAULT_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_MAX_LENGTH</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;&#39;max_length&#39; not defined in the config. &quot;</span>
                <span class="s2">&quot;Setting to default of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_MAX_LENGTH</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context_preprocessor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;context_preprocessor&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_preprocessor</span> <span class="o">=</span> <span class="n">Processor</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">context_preprocessor</span><span class="p">)</span>

<div class="viewcode-block" id="SoftCopyAnswerProcessor.get_vocab_size"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.SoftCopyAnswerProcessor.get_vocab_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Size of Vocab + Size of Dynamic soft-copy based answer space</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Size of vocab + size of dynamic soft-copy answer space.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">answer_vocab_nums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">num_vocab</span>
        <span class="n">answer_vocab_nums</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span>

        <span class="k">return</span> <span class="n">answer_vocab_nums</span></div>

<div class="viewcode-block" id="SoftCopyAnswerProcessor.get_true_vocab_size"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.SoftCopyAnswerProcessor.get_true_vocab_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_true_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actual vocab size which only include size of the vocabulary file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Actual size of vocabs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">num_vocab</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">answers</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;answers&quot;</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">({</span><span class="s2">&quot;answers&quot;</span><span class="p">:</span> <span class="n">answers</span><span class="p">})</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;answers_indices&quot;</span><span class="p">]</span>
        <span class="n">answers</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;answers&quot;</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;answers_scores&quot;</span><span class="p">]</span>

        <span class="n">tokens_scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>

        <span class="n">gt_answers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">answers</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_preprocessor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_preprocessor</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">})[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span>
            <span class="p">]</span>

        <span class="n">answer_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">[:</span><span class="n">length</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">answer_counter</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">accs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">gt_answer</span> <span class="ow">in</span> <span class="n">gt_answers</span><span class="p">:</span>
                <span class="n">other_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">gt_answers</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="n">gt_answer</span><span class="p">]</span>
                <span class="n">matching_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">other_answers</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">token</span><span class="p">]</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matching_answers</span><span class="p">))</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>

            <span class="n">tokens_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span>

        <span class="c1"># Scores are already proper size, see L314. Now,</span>
        <span class="c1"># fix scores for soft copy candidates</span>
        <span class="n">scores</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens_scores</span><span class="p">)</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tokens_scores</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answers&quot;</span><span class="p">:</span> <span class="n">answers</span><span class="p">,</span>
            <span class="s2">&quot;answers_indices&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
            <span class="s2">&quot;answers_scores&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="SimpleWordProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.SimpleWordProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;simple_word&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SimpleWordProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tokenizes a word and processes it.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        tokenizer (function): Type of tokenizer to be used.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">mmf.utils.text</span> <span class="kn">import</span> <span class="n">word_tokenize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">word_tokenize</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)}</span></div>


<div class="viewcode-block" id="SimpleSentenceProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.SimpleSentenceProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;simple_sentence&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SimpleSentenceProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tokenizes a sentence and processes it.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        tokenizer (function): Type of tokenizer to be used.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">mmf.utils.text</span> <span class="kn">import</span> <span class="n">tokenize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenize</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)}</span></div>


<div class="viewcode-block" id="BBoxProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.BBoxProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;bbox&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BBoxProcessor</span><span class="p">(</span><span class="n">VocabProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates bboxes in proper format.</span>
<span class="sd">    Takes in a dict which contains &quot;info&quot; key which is a list of dicts</span>
<span class="sd">    containing following for each of the the bounding box</span>

<span class="sd">    Example bbox input::</span>

<span class="sd">        {</span>
<span class="sd">            &quot;info&quot;: [</span>
<span class="sd">                {</span>
<span class="sd">                    &quot;bounding_box&quot;: {</span>
<span class="sd">                        &quot;top_left_x&quot;: 100,</span>
<span class="sd">                        &quot;top_left_y&quot;: 100,</span>
<span class="sd">                        &quot;width&quot;: 200,</span>
<span class="sd">                        &quot;height&quot;: 300</span>
<span class="sd">                    }</span>
<span class="sd">                },</span>
<span class="sd">                ...</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>


<span class="sd">    This will further return a Sample in a dict with key &quot;bbox&quot; with last</span>
<span class="sd">    dimension of 4 corresponding to &quot;xyxy&quot;. So sample will look like following:</span>

<span class="sd">    Example Sample::</span>

<span class="sd">        Sample({</span>
<span class="sd">            &quot;coordinates&quot;: torch.Size(n, 4),</span>
<span class="sd">            &quot;width&quot;: List[number], # size n</span>
<span class="sd">            &quot;height&quot;: List[number], # size n</span>
<span class="sd">            &quot;bbox_types&quot;: List[str] # size n, either xyxy or xywh.</span>
<span class="sd">            # currently only supports xyxy.</span>
<span class="sd">        })</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">mmf.utils.dataset</span> <span class="kn">import</span> <span class="n">build_bbox_tensors</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_fn</span> <span class="o">=</span> <span class="n">build_bbox_tensors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_extras</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_fn</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">)}</span></div>


<div class="viewcode-block" id="CaptionProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.CaptionProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;caption&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CaptionProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Processes a caption with start, end and pad tokens and returns raw string.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DictConfig): Configuration for caption processor.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;vocab&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;config passed to the processor has no &quot;</span> <span class="s2">&quot;attribute vocab&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">Vocab</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">EOS_INDEX</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_itos</span><span class="p">()[</span><span class="n">w</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">w</span>
            <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">SOS_INDEX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">EOS_INDEX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">PAD_INDEX</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="n">caption</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span> <span class="s2">&quot;caption&quot;</span><span class="p">:</span> <span class="n">caption</span><span class="p">}</span></div>


<div class="viewcode-block" id="EvalAIAnswerProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.EvalAIAnswerProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;evalai_answer&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EvalAIAnswerProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Processes an answer similar to Eval AI</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTRACTIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;aint&quot;</span><span class="p">:</span> <span class="s2">&quot;ain&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;arent&quot;</span><span class="p">:</span> <span class="s2">&quot;aren&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cant&quot;</span><span class="p">:</span> <span class="s2">&quot;can&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;couldve&quot;</span><span class="p">:</span> <span class="s2">&quot;could&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;couldnt&quot;</span><span class="p">:</span> <span class="s2">&quot;couldn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;couldn&#39;tve&quot;</span><span class="p">:</span> <span class="s2">&quot;couldn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;couldnt&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;couldn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;didnt&quot;</span><span class="p">:</span> <span class="s2">&quot;didn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;doesnt&quot;</span><span class="p">:</span> <span class="s2">&quot;doesn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dont&quot;</span><span class="p">:</span> <span class="s2">&quot;don&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hadnt&quot;</span><span class="p">:</span> <span class="s2">&quot;hadn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hadnt&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;hadn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hadn&#39;tve&quot;</span><span class="p">:</span> <span class="s2">&quot;hadn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hasnt&quot;</span><span class="p">:</span> <span class="s2">&quot;hasn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;havent&quot;</span><span class="p">:</span> <span class="s2">&quot;haven&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hed&quot;</span><span class="p">:</span> <span class="s2">&quot;he&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hed&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;he&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;he&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;he&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hes&quot;</span><span class="p">:</span> <span class="s2">&quot;he&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;howd&quot;</span><span class="p">:</span> <span class="s2">&quot;how&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;howll&quot;</span><span class="p">:</span> <span class="s2">&quot;how&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hows&quot;</span><span class="p">:</span> <span class="s2">&quot;how&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Id&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;I&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;I&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;I&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Im&quot;</span><span class="p">:</span> <span class="s2">&quot;I&#39;m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Ive&quot;</span><span class="p">:</span> <span class="s2">&quot;I&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;isnt&quot;</span><span class="p">:</span> <span class="s2">&quot;isn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;itd&quot;</span><span class="p">:</span> <span class="s2">&quot;it&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;itd&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;it&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;it&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;it&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;itll&quot;</span><span class="p">:</span> <span class="s2">&quot;it&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;let&#39;s&quot;</span><span class="p">:</span> <span class="s2">&quot;let&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maam&quot;</span><span class="p">:</span> <span class="s2">&quot;ma&#39;am&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mightnt&quot;</span><span class="p">:</span> <span class="s2">&quot;mightn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mightnt&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;mightn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mightn&#39;tve&quot;</span><span class="p">:</span> <span class="s2">&quot;mightn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mightve&quot;</span><span class="p">:</span> <span class="s2">&quot;might&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mustnt&quot;</span><span class="p">:</span> <span class="s2">&quot;mustn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mustve&quot;</span><span class="p">:</span> <span class="s2">&quot;must&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;neednt&quot;</span><span class="p">:</span> <span class="s2">&quot;needn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;notve&quot;</span><span class="p">:</span> <span class="s2">&quot;not&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;oclock&quot;</span><span class="p">:</span> <span class="s2">&quot;o&#39;clock&quot;</span><span class="p">,</span>
        <span class="s2">&quot;oughtnt&quot;</span><span class="p">:</span> <span class="s2">&quot;oughtn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ow&#39;s&#39;at&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;ow&#39;s&#39;at&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&#39;ows&#39;at&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;ow&#39;s&#39;at&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&#39;ow&#39;sat&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;ow&#39;s&#39;at&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shant&quot;</span><span class="p">:</span> <span class="s2">&quot;shan&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shed&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;she&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;she&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;she&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;she&#39;s&quot;</span><span class="p">:</span> <span class="s2">&quot;she&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shouldve&quot;</span><span class="p">:</span> <span class="s2">&quot;should&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shouldnt&quot;</span><span class="p">:</span> <span class="s2">&quot;shouldn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shouldnt&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;shouldn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shouldn&#39;tve&quot;</span><span class="p">:</span> <span class="s2">&quot;shouldn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;somebody&#39;d&quot;</span><span class="p">:</span> <span class="s2">&quot;somebodyd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;somebodyd&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;somebody&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;somebody&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;somebody&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;somebodyll&quot;</span><span class="p">:</span> <span class="s2">&quot;somebody&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;somebodys&quot;</span><span class="p">:</span> <span class="s2">&quot;somebody&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;someoned&quot;</span><span class="p">:</span> <span class="s2">&quot;someone&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;someoned&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;someone&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;someone&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;someone&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;someonell&quot;</span><span class="p">:</span> <span class="s2">&quot;someone&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;someones&quot;</span><span class="p">:</span> <span class="s2">&quot;someone&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;somethingd&quot;</span><span class="p">:</span> <span class="s2">&quot;something&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;somethingd&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;something&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;something&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;something&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;somethingll&quot;</span><span class="p">:</span> <span class="s2">&quot;something&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;thats&quot;</span><span class="p">:</span> <span class="s2">&quot;that&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;thered&quot;</span><span class="p">:</span> <span class="s2">&quot;there&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;thered&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;there&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;there&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;there&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;therere&quot;</span><span class="p">:</span> <span class="s2">&quot;there&#39;re&quot;</span><span class="p">,</span>
        <span class="s2">&quot;theres&quot;</span><span class="p">:</span> <span class="s2">&quot;there&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;theyd&quot;</span><span class="p">:</span> <span class="s2">&quot;they&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;theyd&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;they&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;they&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;they&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;theyll&quot;</span><span class="p">:</span> <span class="s2">&quot;they&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;theyre&quot;</span><span class="p">:</span> <span class="s2">&quot;they&#39;re&quot;</span><span class="p">,</span>
        <span class="s2">&quot;theyve&quot;</span><span class="p">:</span> <span class="s2">&quot;they&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;twas&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;twas&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wasnt&quot;</span><span class="p">:</span> <span class="s2">&quot;wasn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wed&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;we&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;we&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;we&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;weve&quot;</span><span class="p">:</span> <span class="s2">&quot;we&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;werent&quot;</span><span class="p">:</span> <span class="s2">&quot;weren&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whatll&quot;</span><span class="p">:</span> <span class="s2">&quot;what&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whatre&quot;</span><span class="p">:</span> <span class="s2">&quot;what&#39;re&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whats&quot;</span><span class="p">:</span> <span class="s2">&quot;what&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whatve&quot;</span><span class="p">:</span> <span class="s2">&quot;what&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whens&quot;</span><span class="p">:</span> <span class="s2">&quot;when&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whered&quot;</span><span class="p">:</span> <span class="s2">&quot;where&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wheres&quot;</span><span class="p">:</span> <span class="s2">&quot;where&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whereve&quot;</span><span class="p">:</span> <span class="s2">&quot;where&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whod&quot;</span><span class="p">:</span> <span class="s2">&quot;who&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whod&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;who&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;who&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;who&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wholl&quot;</span><span class="p">:</span> <span class="s2">&quot;who&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whos&quot;</span><span class="p">:</span> <span class="s2">&quot;who&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whove&quot;</span><span class="p">:</span> <span class="s2">&quot;who&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whyll&quot;</span><span class="p">:</span> <span class="s2">&quot;why&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whyre&quot;</span><span class="p">:</span> <span class="s2">&quot;why&#39;re&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whys&quot;</span><span class="p">:</span> <span class="s2">&quot;why&#39;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wont&quot;</span><span class="p">:</span> <span class="s2">&quot;won&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wouldve&quot;</span><span class="p">:</span> <span class="s2">&quot;would&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wouldnt&quot;</span><span class="p">:</span> <span class="s2">&quot;wouldn&#39;t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wouldnt&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;wouldn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wouldn&#39;tve&quot;</span><span class="p">:</span> <span class="s2">&quot;wouldn&#39;t&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yall&quot;</span><span class="p">:</span> <span class="s2">&quot;y&#39;all&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yall&#39;ll&quot;</span><span class="p">:</span> <span class="s2">&quot;y&#39;all&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;y&#39;allll&quot;</span><span class="p">:</span> <span class="s2">&quot;y&#39;all&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yall&#39;d&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;y&#39;all&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;y&#39;alld&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;y&#39;all&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;y&#39;all&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;y&#39;all&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;youd&quot;</span><span class="p">:</span> <span class="s2">&quot;you&#39;d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;youd&#39;ve&quot;</span><span class="p">:</span> <span class="s2">&quot;you&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;you&#39;dve&quot;</span><span class="p">:</span> <span class="s2">&quot;you&#39;d&#39;ve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;youll&quot;</span><span class="p">:</span> <span class="s2">&quot;you&#39;ll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;youre&quot;</span><span class="p">:</span> <span class="s2">&quot;you&#39;re&quot;</span><span class="p">,</span>
        <span class="s2">&quot;youve&quot;</span><span class="p">:</span> <span class="s2">&quot;you&#39;ve&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">NUMBER_MAP</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;none&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zero&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;one&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;two&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;three&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;four&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;five&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;six&quot;</span><span class="p">:</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;seven&quot;</span><span class="p">:</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eight&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nine&quot;</span><span class="p">:</span> <span class="s2">&quot;9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ten&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">ARTICLES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;an&quot;</span><span class="p">,</span> <span class="s2">&quot;the&quot;</span><span class="p">]</span>
    <span class="n">PERIOD_STRIP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?!&lt;=\d)(\.)(?!\d)&quot;</span><span class="p">)</span>
    <span class="n">COMMA_STRIP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?&lt;=\d)(\,)+(?=\d)&quot;</span><span class="p">)</span>
    <span class="n">PUNCTUATIONS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;;&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[&quot;</span><span class="p">,</span>
        <span class="s2">&quot;]&quot;</span><span class="p">,</span>
        <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
        <span class="s2">&quot;{&quot;</span><span class="p">,</span>
        <span class="s2">&quot;}&quot;</span><span class="p">,</span>
        <span class="s2">&quot;(&quot;</span><span class="p">,</span>
        <span class="s2">&quot;)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;=&quot;</span><span class="p">,</span>
        <span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;@&quot;</span><span class="p">,</span>
        <span class="s2">&quot;`&quot;</span><span class="p">,</span>
        <span class="s2">&quot;,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="s2">&quot;!&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">word_tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot; &#39;s&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">process_punctuation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_text</span><span class="p">):</span>
        <span class="n">out_text</span> <span class="o">=</span> <span class="n">in_text</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PUNCTUATIONS</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">in_text</span> <span class="ow">or</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">in_text</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COMMA_STRIP</span><span class="p">,</span> <span class="n">in_text</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">out_text</span> <span class="o">=</span> <span class="n">out_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_text</span> <span class="o">=</span> <span class="n">out_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">out_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PERIOD_STRIP</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">out_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_text</span>

    <span class="k">def</span> <span class="nf">process_digit_article</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_text</span><span class="p">):</span>
        <span class="n">out_text</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">temp_text</span> <span class="o">=</span> <span class="n">in_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">temp_text</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_MAP</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ARTICLES</span><span class="p">:</span>
                <span class="n">out_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">for</span> <span class="n">word_id</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTIONS</span><span class="p">:</span>
                <span class="n">out_text</span><span class="p">[</span><span class="n">word_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTIONS</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
        <span class="n">out_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_text</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_punctuation</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_digit_article</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span></div>


<div class="viewcode-block" id="PhocProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.PhocProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;phoc&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PhocProcessor</span><span class="p">(</span><span class="n">VocabProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute PHOC features from text tokens</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">mmf.utils.phoc</span> <span class="kn">import</span> <span class="n">build_phoc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_build_phoc</span> <span class="o">=</span> <span class="n">build_phoc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_extras</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">_map_strings_to_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>

        <span class="n">phoc_dim</span> <span class="o">=</span> <span class="mi">604</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="n">phoc_dim</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PAD_INDEX</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_phoc</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="CopyProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.CopyProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;copy&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CopyProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy boxes from numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_length</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;blob&quot;</span><span class="p">]</span>
        <span class="n">final_blob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,)</span> <span class="o">+</span> <span class="n">blob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">blob</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">final_blob</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">blob</span><span class="p">)]</span> <span class="o">=</span> <span class="n">blob</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_blob</span><span class="p">)]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;blob&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">final_blob</span><span class="p">)}</span></div>


<div class="viewcode-block" id="M4CAnswerProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.M4CAnswerProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;m4c_answer&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">M4CAnswerProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a TextVQA answer for iterative decoding in M4C</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span> <span class="o">=</span> <span class="n">VocabDict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">vocab_file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PAD_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="s2">&quot;&lt;pad&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BOS_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="s2">&quot;&lt;s&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EOS_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="s2">&quot;&lt;/s&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UNK_IDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span>

        <span class="c1"># make sure PAD_IDX, BOS_IDX and PAD_IDX are valid (not &lt;unk&gt;)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAD_IDX</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">BOS_IDX</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">EOS_IDX</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">UNK_INDEX</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAD_IDX</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">answer_preprocessor</span> <span class="o">=</span> <span class="n">Processor</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_preprocessor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_answers</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_answers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_copy_steps</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_copy_steps</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_copy_steps</span> <span class="o">&gt;=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">match_answer_to_unk</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<div class="viewcode-block" id="M4CAnswerProcessor.match_answer_to_vocab_ocr_seq"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.M4CAnswerProcessor.match_answer_to_vocab_ocr_seq">[docs]</a>    <span class="k">def</span> <span class="nf">match_answer_to_vocab_ocr_seq</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">,</span> <span class="n">vocab2idx_dict</span><span class="p">,</span> <span class="n">ocr2inds_dict</span><span class="p">,</span> <span class="n">max_match_num</span><span class="o">=</span><span class="mi">20</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Match an answer to a list of sequences of indices</span>
<span class="sd">        each index corresponds to either a fixed vocabulary or an OCR token</span>
<span class="sd">        (in the index address space, the OCR tokens are after the fixed vocab)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_vocab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab2idx_dict</span><span class="p">)</span>

        <span class="n">answer_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
        <span class="n">answer_word_matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">answer_words</span><span class="p">:</span>
            <span class="c1"># match answer word to fixed vocabulary</span>
            <span class="n">matched_inds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocab2idx_dict</span><span class="p">:</span>
                <span class="n">matched_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vocab2idx_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
            <span class="c1"># match answer word to OCR</span>
            <span class="c1"># we put OCR after the fixed vocabulary in the answer index space</span>
            <span class="c1"># so add num_vocab offset to the OCR index</span>
            <span class="n">matched_inds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">num_vocab</span> <span class="o">+</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">ocr2inds_dict</span><span class="p">[</span><span class="n">word</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_inds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_answer_to_unk</span><span class="p">:</span>
                    <span class="n">matched_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vocab2idx_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>
            <span class="n">answer_word_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_inds</span><span class="p">)</span>

        <span class="c1"># expand per-word matched indices into the list of matched sequences</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_word_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">idx_seq_list</span> <span class="o">=</span> <span class="p">[()]</span>
        <span class="k">for</span> <span class="n">matched_inds</span> <span class="ow">in</span> <span class="n">answer_word_matches</span><span class="p">:</span>
            <span class="n">idx_seq_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">seq</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx</span><span class="p">,)</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">idx_seq_list</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">matched_inds</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_seq_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_match_num</span><span class="p">:</span>
                <span class="n">idx_seq_list</span> <span class="o">=</span> <span class="n">idx_seq_list</span><span class="p">[:</span><span class="n">max_match_num</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">idx_seq_list</span></div>

    <span class="k">def</span> <span class="nf">get_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">answer_vocab_nums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">num_vocab</span>
        <span class="n">answer_vocab_nums</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span>

        <span class="k">return</span> <span class="n">answer_vocab_nums</span>

    <span class="k">def</span> <span class="nf">get_true_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">num_vocab</span>

    <span class="k">def</span> <span class="nf">compute_answer_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answers</span><span class="p">):</span>
        <span class="n">gt_answers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">answers</span><span class="p">))</span>
        <span class="n">unique_answers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">answers</span><span class="p">))</span>
        <span class="n">unique_answer_scores</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_answers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">unique_answer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_answers</span><span class="p">):</span>
            <span class="n">accs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">gt_answer</span> <span class="ow">in</span> <span class="n">gt_answers</span><span class="p">:</span>
                <span class="n">other_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">gt_answers</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="n">gt_answer</span><span class="p">]</span>
                <span class="n">matching_answers</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">other_answers</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">unique_answer</span>
                <span class="p">]</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matching_answers</span><span class="p">))</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            <span class="n">unique_answer_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span>
        <span class="n">unique_answer2score</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">a</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_answers</span><span class="p">,</span> <span class="n">unique_answer_scores</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">unique_answer2score</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">answers</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;answers&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">answers</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;sampled_idx_seq&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;train_prev_inds&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_copy_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
            <span class="p">}</span>

        <span class="n">answers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_preprocessor</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">})[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_answers</span>

        <span class="c1"># Step 1: calculate the soft score of ground-truth answers</span>
        <span class="n">unique_answer2score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_answer_scores</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span>

        <span class="c1"># Step 2: fill the first step soft scores for tokens</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_copy_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vocab_size</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span>
        <span class="p">)</span>

        <span class="c1"># match answers to fixed vocabularies and OCR tokens.</span>
        <span class="n">ocr2inds_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]):</span>
            <span class="n">ocr2inds_dict</span><span class="p">[</span><span class="n">token</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">answer_dec_inds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">match_answer_to_vocab_ocr_seq</span><span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">word2idx_dict</span><span class="p">,</span> <span class="n">ocr2inds_dict</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">answers</span>
        <span class="p">]</span>

        <span class="c1"># Collect all the valid decoding sequences for each answer.</span>
        <span class="c1"># This part (idx_seq_list) was pre-computed in imdb (instead of online)</span>
        <span class="c1"># to save time</span>
        <span class="n">all_idx_seq_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">answer</span><span class="p">,</span> <span class="n">idx_seq_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">answers</span><span class="p">,</span> <span class="n">answer_dec_inds</span><span class="p">):</span>
            <span class="n">all_idx_seq_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">idx_seq_list</span><span class="p">)</span>
            <span class="c1"># fill in the soft score for the first decoding step</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">unique_answer2score</span><span class="p">[</span><span class="n">answer</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx_seq</span> <span class="ow">in</span> <span class="n">idx_seq_list</span><span class="p">:</span>
                <span class="n">score_idx</span> <span class="o">=</span> <span class="n">idx_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># the scores for the decoding Step 0 will be the maximum</span>
                <span class="c1"># among all answers starting with that vocab</span>
                <span class="c1"># for example:</span>
                <span class="c1"># if &quot;red apple&quot; has score 0.7 and &quot;red flag&quot; has score 0.8</span>
                <span class="c1"># the score for &quot;red&quot; at Step 0 will be max(0.7, 0.8) = 0.8</span>
                <span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">score_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">score_idx</span><span class="p">],</span> <span class="n">score</span><span class="p">)</span>

        <span class="c1"># train_prev_inds is the previous prediction indices in auto-regressive</span>
        <span class="c1"># decoding</span>
        <span class="n">train_prev_inds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_copy_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="c1"># train_loss_mask records the decoding steps where losses are applied</span>
        <span class="n">train_loss_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_copy_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_idx_seq_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># sample a random decoding answer sequence for teacher-forcing</span>
            <span class="n">idx_seq</span> <span class="o">=</span> <span class="n">all_idx_seq_list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_idx_seq_list</span><span class="p">))]</span>
            <span class="n">dec_step_num</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_seq</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_copy_steps</span><span class="p">)</span>
            <span class="n">train_loss_mask</span><span class="p">[:</span><span class="n">dec_step_num</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">train_prev_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BOS_IDX</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dec_step_num</span><span class="p">):</span>
                <span class="n">train_prev_inds</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_seq</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">score_idx</span> <span class="o">=</span> <span class="n">idx_seq</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_seq</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">EOS_IDX</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">score_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_seq</span> <span class="o">=</span> <span class="p">()</span>

        <span class="n">answer_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;answers&quot;</span><span class="p">:</span> <span class="n">answers</span><span class="p">,</span>
            <span class="s2">&quot;answers_scores&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
            <span class="s2">&quot;sampled_idx_seq&quot;</span><span class="p">:</span> <span class="n">idx_seq</span><span class="p">,</span>
            <span class="s2">&quot;train_prev_inds&quot;</span><span class="p">:</span> <span class="n">train_prev_inds</span><span class="p">,</span>
            <span class="s2">&quot;train_loss_mask&quot;</span><span class="p">:</span> <span class="n">train_loss_mask</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">answer_info</span></div>


<div class="viewcode-block" id="M4CCaptionProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.M4CCaptionProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;m4c_caption&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">M4CCaptionProcessor</span><span class="p">(</span><span class="n">M4CAnswerProcessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">re</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SENTENCE_SPLIT_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\W+)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">match_answer_to_unk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">):</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sentence</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot; &#39;s&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SENTENCE_SPLIT_REGEX</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tokens</span>

    <span class="k">def</span> <span class="nf">compute_answer_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answers</span><span class="p">):</span>
        <span class="n">unique_answer2score</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">unique_answer2score</span></div>


<div class="viewcode-block" id="MaskedRegionProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.MaskedRegionProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;masked_region&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MaskedRegionProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Masks a region with probability `mask_probability`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_prob</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_probability&quot;</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_region_prob</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_region_probability&quot;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">image_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
            <span class="c1"># mask token with 15% probability</span>
            <span class="k">if</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_prob</span><span class="p">:</span>
                <span class="n">prob</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_prob</span>

                <span class="k">if</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_region_prob</span><span class="p">:</span>
                    <span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">image_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no masking token (will be ignored by loss function later)</span>
                <span class="n">image_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">image_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span></div>


<div class="viewcode-block" id="TransformerBboxProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.TransformerBboxProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;transformer_bbox&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TransformerBboxProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a bounding box and returns a array of normalized bbox positions and area</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox_key</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bbox_key&quot;</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_width_key</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_width_key&quot;</span><span class="p">,</span> <span class="s2">&quot;image_width&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_height_key</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_height_key&quot;</span><span class="p">,</span> <span class="s2">&quot;image_height&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox_key</span><span class="p">]</span>
        <span class="n">image_w</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_width_key</span><span class="p">]</span>
        <span class="n">image_h</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height_key</span><span class="p">]</span>
        <span class="n">image_location</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bbox</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">image_location</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">bbox</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">image_location</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">image_location</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">image_w</span> <span class="o">*</span> <span class="n">image_h</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">image_w</span>
        <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">image_h</span>
        <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">image_w</span>
        <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_location</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">image_h</span>
        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_location</span>
        <span class="k">return</span> <span class="n">item</span></div>


<div class="viewcode-block" id="MultiClassFromFileConfig"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.MultiClassFromFileConfig">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">MultiClassFromFileConfig</span><span class="p">:</span>
    <span class="c1"># Vocab file containing the strings for the available classes</span>
    <span class="n">vocab_file</span><span class="p">:</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="MultiClassFromFile"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.MultiClassFromFile">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;multi_class_from_file&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MultiClassFromFile</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Label processor for multi class cases where the labels are</span>
<span class="sd">    saved in a file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">MultiClassFromFileConfig</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_vocab</span> <span class="o">=</span> <span class="n">VocabDict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">vocab_file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">item</span>

        <span class="c1"># Remove UNK by subtracting 1 from output</span>
        <span class="c1"># UNK will always be at 0 even if it is not in vocab as it is automatically</span>
        <span class="c1"># always added by vocab dict</span>
        <span class="n">class_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_vocab</span><span class="o">.</span><span class="n">word2idx</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">class_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> is not present in vocab file&quot;</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;class_index&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">class_index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)}</span></div>


<div class="viewcode-block" id="DETRImageAndTargetProcessor"><a class="viewcode-back" href="../../../../lib/datasets/processors.html#mmf.datasets.processors.processors.DETRImageAndTargetProcessor">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_processor</span><span class="p">(</span><span class="s2">&quot;detr_image_and_target&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DETRImageAndTargetProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process a detection image and target in consistent with DETR. At training time,</span>
<span class="sd">    random crop is done. At test time, an image is deterministically resized with short</span>
<span class="sd">    side equal to `image_size` (while ensuring its long side no larger than `max_size`)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">mmf.datasets.processors</span> <span class="kn">import</span> <span class="n">detection_transforms</span> <span class="k">as</span> <span class="n">T</span>

        <span class="n">train_image_sizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_image_sizes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_transform</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">T</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
                <span class="n">T</span><span class="o">.</span><span class="n">RandomSelect</span><span class="p">(</span>
                    <span class="n">T</span><span class="o">.</span><span class="n">RandomResize</span><span class="p">(</span><span class="n">train_image_sizes</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_size</span><span class="p">),</span>
                    <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">T</span><span class="o">.</span><span class="n">RandomResize</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_resize_random_sizes</span><span class="p">)),</span>
                            <span class="n">T</span><span class="o">.</span><span class="n">RandomSizeCrop</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="o">.</span><span class="n">train_crop_size</span><span class="p">),</span>
                            <span class="n">T</span><span class="o">.</span><span class="n">RandomResize</span><span class="p">(</span><span class="n">train_image_sizes</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_size</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_transform</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">T</span><span class="o">.</span><span class="n">RandomResize</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">test_image_size</span><span class="p">],</span> <span class="n">max_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_size</span><span class="p">),</span>
                <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">dataset_type</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;dataset_type&quot;</span><span class="p">]</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dataset_type</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
            <span class="n">img</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_transform</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dataset_type</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span> <span class="ow">or</span> <span class="n">dataset_type</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
            <span class="n">img</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_transform</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown dataset_type: </span><span class="si">{</span><span class="n">dataset_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="n">img</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">}</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Facebook AI Research.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
         <script src="../../../../_static/jquery.js"></script>
         <script src="../../../../_static/underscore.js"></script>
         <script src="../../../../_static/doctools.js"></script>
     

  

  <script type="text/javascript" src="../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->


  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://mmf.sh/" class="footer-logo"></a>
      </div>
      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://mmf.sh/">MMF</a></li>
            <li><a href="https://mmf.sh/docs">Get Started</a></li>
            <li><a href="https://mmf.sh/docs/getting_started/features">Features</a></li>
            <li><a href="https://github.com/facebookresearch/master/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="">Resources</a></li>
            <li><a href="https://mmf.sh/docs">Docs</a></li>
            <li><a href="https://mmf.sh/api">API</a></li>
            <li><a href="https://github.com/facebookresearch/master/issues" target="_blank">Github Issues</a></li>
          </ul>
        </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebooks Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://mmf.sh/" aria-label="MMF"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://mmf.sh/docs">Get Started</a>
          </li>

          <li>
            <a href="https://mmf.sh/docs/getting_started/features">Features</a>
          </li>

          <li>
            <a href="https://mmf.sh/docs">Docs</a>
          </li>

          <li class="active">
            <a href="https://mmf.sh/api">API</a>
          </li>
          <li>
            <a href="https://github.com/facebookresearch/mmf">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>